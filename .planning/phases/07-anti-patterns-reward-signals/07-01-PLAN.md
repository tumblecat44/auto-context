---
phase: 07-anti-patterns-reward-signals
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - agents/extract-patterns.md
  - scripts/inject-context.sh
  - scripts/preserve-context.sh
autonomous: true
requirements:
  - ANTI-01
  - ANTI-02
  - ANTI-03
  - ANTI-04
  - RWRD-01
  - RWRD-02
  - RWRD-03

must_haves:
  truths:
    - "Stop hook agent detects Write->Edit correction patterns with intervening event heuristic"
    - "Stop hook agent tracks cross-session error patterns in anti-patterns.json"
    - "Stop hook agent computes per-session reward scores from implicit and explicit signals"
    - "Anti-patterns with stage:active are injected into CLAUDE.md in a Do NOT section"
    - "Anti-pattern injection uses a 200-token sub-budget within the 1000-token total"
    - "rewards.json is initialized at SessionStart and backed up at PreCompact"
  artifacts:
    - path: "agents/extract-patterns.md"
      provides: "Extended extraction agent with correction detection, error tracking, and reward computation"
      contains: "Correction Detection"
    - path: "scripts/inject-context.sh"
      provides: "Anti-pattern injection into CLAUDE.md with token sub-budget and rewards.json initialization"
      contains: "Do NOT"
    - path: "scripts/preserve-context.sh"
      provides: "PreCompact backup including rewards.json"
      contains: "rewards.json"
  key_links:
    - from: "agents/extract-patterns.md"
      to: ".auto-context/anti-patterns.json"
      via: "agent writes correction/error anti-patterns"
      pattern: "source.*correction|source.*error"
    - from: "agents/extract-patterns.md"
      to: ".auto-context/rewards.json"
      via: "agent writes per-session reward entry"
      pattern: "rewards\\.json"
    - from: "scripts/inject-context.sh"
      to: ".auto-context/anti-patterns.json"
      via: "reads active anti-patterns for CLAUDE.md injection"
      pattern: "anti-patterns\\.json.*stage.*active"
---

<objective>
Extend the Stop hook extraction agent with correction detection, cross-session error tracking, and reward signal computation. Modify the SessionStart injection pipeline to include active anti-patterns in CLAUDE.md with a dedicated 200-token sub-budget. Initialize rewards.json at SessionStart and add it to PreCompact backup.

Purpose: Enable the plugin to detect what Claude should NOT do (from corrections and errors) and measure convention quality through reward signals, completing the negative feedback loop alongside the existing positive convention pipeline.
Output: Extended extraction agent prompt, modified injection pipeline with anti-pattern CLAUDE.md section, rewards.json initialization and backup.
</objective>

<execution_context>
@/Users/dgsw67/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dgsw67/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-anti-patterns-reward-signals/07-RESEARCH.md

@agents/extract-patterns.md
@scripts/inject-context.sh
@scripts/preserve-context.sh
@scripts/observe-tool.sh
@scripts/detect-feedback.sh
@scripts/lib/tokens.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend extraction agent with correction detection, error tracking, and reward computation</name>
  <files>agents/extract-patterns.md</files>
  <action>
Extend the existing `agents/extract-patterns.md` agent prompt by adding three new sections AFTER the existing "Final Instructions" section. Restructure the document so Final Instructions comes last. The agent should perform correction detection and reward computation BEFORE pattern extraction (faster metadata-only work first, slower code-reading work second).

**Add section: "## Correction Detection (Phase 7)" after Pattern Analysis + Classification + Filtering + Evidence + Deduplication + Output Format:**

1. **Write->Edit Pair Analysis** subsection:
   - Collect all `file_write` and `file_edit` events from session-log.jsonl
   - Group by file path
   - For each file with BOTH a `file_write` AND subsequent `file_edit`:
     a. Check for intervening events between the Write and Edit (bash_command, explicit_feedback, file_write/file_edit to a DIFFERENT file)
     b. If intervening events exist: potential correction. Use Read tool to examine the file, determine what was corrected, write concise anti-pattern to `.auto-context/anti-patterns.json` with `source: "correction"`, `confidence: 0.5`, `stage: "active"`, `occurrences: 1`, `evidence: [{file, write_ts, edit_ts}]`
     c. If NO intervening events (Write immediately followed by Edit on same file): skip -- likely normal Claude refinement
   - Files written but NEVER edited = positive implicit signals (count for reward)

2. **Error Pattern Analysis** subsection:
   - Collect all `bash_error` events from session-log.jsonl
   - For each error, extract normalized error key: strip absolute path prefixes with sed, strip line/column numbers, keep first 100 chars
   - Read existing `anti-patterns.json` entries with `source: "error"`
   - For matching error pattern: increment `occurrences`, add `session_id` to `sessions_seen` array
   - If `occurrences >= 2` AND `sessions_seen` has 2+ unique sessions: set `stage: "active"`, `confidence: 0.6`
   - If no match: add new entry with `source: "error"`, `stage: "observation"`, `confidence: 0.3`, `occurrences: 1`, `sessions_seen: [session_id]`, `error_pattern: "normalized error text"`

3. **Deduplication for anti-patterns**: Before writing correction-detected anti-patterns, check existing entries. If semantically equivalent exists, increment occurrences instead of duplicating.

**Add section: "## Reward Signal Computation (Phase 7)" after Correction Detection:**

1. Count implicit signals:
   - `implicit_positive` = count of files written but not subsequently edited
   - `implicit_negative` = count of files with Write->Edit corrections (detected above)
2. Count explicit signals from session log:
   - `explicit_positive` = count of `explicit_feedback` events with `type: "convention"`
   - `explicit_negative` = count of `explicit_feedback` events with `type: "anti-pattern"`
3. Compute weighted score per FDBK-03 (10x explicit weight):
   - `weighted_positive = implicit_positive + (explicit_positive * 10)`
   - `weighted_negative = implicit_negative + (explicit_negative * 10)`
   - `total = weighted_positive + weighted_negative`
   - `reward_score = weighted_positive / total` (if total > 0, else 0.5)
4. Read existing `.auto-context/rewards.json` array (or start with `[]`), append new entry:
   ```json
   {"session_id": "...", "ts": "ISO-8601", "implicit_positive": N, "implicit_negative": N, "explicit_positive": N, "explicit_negative": N, "reward_score": 0.XX, "files_analyzed": N}
   ```
5. Write complete array atomically (read -> append -> write, same pattern as candidates.json)

**Restructure Final Instructions:**
- Move existing "## Final Instructions" to end of file
- Update timeout reference from 120 to 180 seconds
- Add: "Perform correction detection and reward computation FIRST (metadata-only, fast), then proceed with pattern extraction (requires file reads, slower)"
- Add: "If any error occurs during correction detection or reward computation, log the issue silently and continue with pattern extraction"
- Keep: always respond with `{"ok": true}`, never block Claude

**Important constraints:**
- Do NOT modify existing Pattern Analysis, Classification, Evidence, Deduplication, or Output Format sections
- The new sections are additive extensions to the existing prompt
- Preserve the existing candidate writing schema exactly
  </action>
  <verify>
    <automated>grep -c "Correction Detection" agents/extract-patterns.md | grep -q "1" && grep -c "Reward Signal" agents/extract-patterns.md | grep -q "1" && grep -c "Error Pattern" agents/extract-patterns.md | grep -q "1" && echo "PASS: all sections present" || echo "FAIL"</automated>
    <manual>Read agents/extract-patterns.md and verify: (1) Pre-Checks still at top, (2) Pattern Analysis sections preserved unchanged, (3) Correction Detection section with Write->Edit heuristic, (4) Error Pattern Analysis with normalization, (5) Reward Signal Computation with 10x weighting formula, (6) Final Instructions at end with 180s timeout</manual>
  </verify>
  <done>The extraction agent prompt contains correction detection with intervening-event heuristic, cross-session error tracking with normalization, and reward signal computation with 10x explicit weighting. Existing pattern extraction functionality is preserved unchanged. Timeout reference updated to 180s.</done>
</task>

<task type="auto">
  <name>Task 2: Add anti-pattern CLAUDE.md injection, rewards.json initialization, and PreCompact backup</name>
  <files>scripts/inject-context.sh, scripts/preserve-context.sh, hooks/hooks.json</files>
  <action>
**Modify `scripts/inject-context.sh`:**

1. **Add rewards.json initialization** alongside existing data store init block (around line 23):
   ```bash
   [ -f "$STORE_DIR/rewards.json" ]       || echo '[]' > "$STORE_DIR/rewards.json"
   ```

2. **Add rewards.json to context restoration block** (around line 35-44). Add `rewards.json` to the restore loop alongside conventions.json, candidates.json, anti-patterns.json, lifecycle.json.

3. **Replace the convention injection section** (lines 80-116) with a dual-section injection that includes anti-patterns:

   a. Read active anti-patterns sorted by confidence descending:
   ```bash
   AP_ACTIVE=$(jq '[.[] | select(.stage == "active")] | sort_by(-.confidence)' "$STORE_DIR/anti-patterns.json" 2>/dev/null || echo "[]")
   AP_INJ_COUNT=$(echo "$AP_ACTIVE" | jq 'length')
   ```

   b. Build anti-pattern markdown section with 200-token sub-budget:
   ```bash
   AP_CONTENT=""
   if [ "$AP_INJ_COUNT" -gt 0 ]; then
     AP_CONTENT=$(echo "$AP_ACTIVE" | jq -r '"## Do NOT (Auto-Context)\n\n" + (map("- " + .text) | join("\n"))')
     AP_CONTENT=$(enforce_budget "$AP_CONTENT" 200)
   fi
   ```

   c. Calculate remaining budget for conventions (subtract anti-pattern tokens + 50 buffer for footer):
   ```bash
   AP_TOKENS=$(estimate_tokens "$AP_CONTENT")
   CONV_BUDGET=$((TOKEN_BUDGET - AP_TOKENS - 50))
   [ "$CONV_BUDGET" -lt 100 ] && CONV_BUDGET=100  # minimum convention budget
   ```

   d. Build convention section with adjusted budget (reuse existing ACTIVE_CONVS logic):
   ```bash
   CONV_CONTENT=""
   if [ "$CONV_COUNT" -gt 0 ]; then
     CONV_CONTENT=$(echo "$ACTIVE_CONVS" | jq -r '"## Project Conventions (Auto-Context)\n\n" + (map("- " + .text) | join("\n"))')
     CONV_CONTENT=$(enforce_budget "$CONV_CONTENT" "$CONV_BUDGET")
   fi
   ```

   e. Combine sections and inject:
   ```bash
   FULL_CONTENT=""
   [ -n "$CONV_CONTENT" ] && FULL_CONTENT="$CONV_CONTENT"
   if [ -n "$AP_CONTENT" ]; then
     [ -n "$FULL_CONTENT" ] && FULL_CONTENT="${FULL_CONTENT}\n\n${AP_CONTENT}" || FULL_CONTENT="$AP_CONTENT"
   fi
   FOOTER="\n\n_Auto-generated by auto-context plugin. Do not edit between markers._"
   if [ -n "$FULL_CONTENT" ]; then
     FULL_CONTENT="${FULL_CONTENT}${FOOTER}"
     ensure_markers "$CLAUDE_MD"
     inject_content "$CLAUDE_MD" "$(printf '%b' "$FULL_CONTENT")"
   else
     ensure_markers "$CLAUDE_MD"
     inject_content "$CLAUDE_MD" "_No conventions yet. Auto-Context is learning from your sessions._"
   fi
   ```

4. **Keep the existing AP_COUNT variable** used in the status line (line 96-97 area) -- it already reads anti-patterns.json length. No change needed there.

**Modify `scripts/preserve-context.sh`:**

Update the backup loop to include rewards.json:
```bash
for f in conventions.json candidates.json anti-patterns.json lifecycle.json rewards.json; do
```

**Modify `hooks/hooks.json`:**

Update the Stop hook timeout from 120 to 180 seconds to accommodate the extended agent responsibilities:
```json
"timeout": 180,
```

**Important constraints:**
- Preserve all existing functionality: lifecycle pipeline, session counter, stale log detection, status line output
- The `printf '%b'` is needed to interpret `\n` escape sequences in the combined content
- Use the existing `enforce_budget` function from `lib/tokens.sh` for both sections
- Anti-pattern injection only includes entries with `stage: "active"` (not observation or decayed)
- If no active anti-patterns exist, skip the "Do NOT" section entirely (no empty heading)
  </action>
  <verify>
    <automated>grep -q "rewards.json" scripts/inject-context.sh && grep -q "Do NOT" scripts/inject-context.sh && grep -q "rewards.json" scripts/preserve-context.sh && grep -q '"timeout": 180' hooks/hooks.json && echo "PASS" || echo "FAIL"</automated>
    <manual>Verify inject-context.sh: (1) rewards.json initialized if missing, (2) rewards.json in restore loop, (3) anti-pattern section built with 200-token sub-budget, (4) convention budget reduced by anti-pattern usage, (5) both sections combined before injection, (6) empty anti-pattern case handled (no empty heading). Verify preserve-context.sh includes rewards.json in backup loop. Verify hooks.json Stop timeout is 180.</manual>
  </verify>
  <done>inject-context.sh injects active anti-patterns as "Do NOT" section in CLAUDE.md with 200-token sub-budget, initializes rewards.json, and restores it from backup. preserve-context.sh backs up rewards.json. hooks.json Stop timeout is 180 seconds.</done>
</task>

</tasks>

<verification>
1. `grep -c "Correction Detection" agents/extract-patterns.md` returns 1
2. `grep -c "Reward Signal" agents/extract-patterns.md` returns 1
3. `grep "rewards.json" scripts/inject-context.sh` shows init + restore lines
4. `grep "Do NOT" scripts/inject-context.sh` shows anti-pattern section building
5. `grep "rewards.json" scripts/preserve-context.sh` shows backup inclusion
6. `jq '.hooks.Stop[0].hooks[0].timeout' hooks/hooks.json` returns 180
7. No syntax errors in shell scripts: `bash -n scripts/inject-context.sh && bash -n scripts/preserve-context.sh`
</verification>

<success_criteria>
- The extraction agent prompt includes correction detection, error tracking, and reward computation sections
- inject-context.sh builds a dual-section CLAUDE.md content (conventions + anti-patterns) with independent token budgets
- rewards.json is initialized at SessionStart and backed up at PreCompact
- Stop hook timeout increased to 180s for extended agent responsibilities
- All existing functionality preserved (lifecycle pipeline, session counter, status line)
</success_criteria>

<output>
After completion, create `.planning/phases/07-anti-patterns-reward-signals/07-01-SUMMARY.md`
</output>
