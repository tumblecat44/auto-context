---
phase: 06-convention-lifecycle-review
plan: 02
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - skills/ac-review/SKILL.md
  - skills/ac-status/SKILL.md
autonomous: true
requirements:
  - LIFE-06
  - TRNS-01
  - TRNS-02

must_haves:
  truths:
    - "/ac-review presents review_pending candidates with text, confidence, evidence, observation count, and sessions_seen"
    - "/ac-review allows user to approve, reject, or edit each candidate one at a time"
    - "Approved candidates are moved from candidates.json to conventions.json with stage:active"
    - "Each review decision is written to disk immediately (not batched at end)"
    - "No extraction-sourced candidate reaches CLAUDE.md without explicit /ac-review approval (LIFE-06). Explicit feedback (confidence:1.0) and bootstrap conventions bypass the gate by design, as the user already approved them."
    - "/ac-status shows observation counts, candidate counts, convention counts by stage, anti-pattern counts"
    - "Both skills have disable-model-invocation: true"
  artifacts:
    - path: "skills/ac-review/SKILL.md"
      provides: "Mandatory review gate skill for convention approval"
      contains: "disable-model-invocation: true"
    - path: "skills/ac-status/SKILL.md"
      provides: "Pipeline status dashboard skill"
      contains: "disable-model-invocation: true"
  key_links:
    - from: "skills/ac-review/SKILL.md"
      to: ".auto-context/candidates.json"
      via: "Read + jq filter for stage==review_pending"
      pattern: "candidates\\.json"
    - from: "skills/ac-review/SKILL.md"
      to: ".auto-context/conventions.json"
      via: "Write approved entries with stage:active"
      pattern: "conventions\\.json"
    - from: "skills/ac-review/SKILL.md"
      to: ".auto-context/changelog.jsonl"
      via: "Log each approve/reject decision"
      pattern: "changelog\\.jsonl"
    - from: "skills/ac-status/SKILL.md"
      to: ".auto-context/lifecycle.json"
      via: "Read session counter and lifecycle metadata"
      pattern: "lifecycle\\.json"
---

<objective>
Create the /ac-review and /ac-status skills. /ac-review is the mandatory user review gate (LIFE-06) -- no convention reaches CLAUDE.md without explicit approval. /ac-status provides full visibility into the convention pipeline.

Purpose: /ac-review enforces the safety guarantee that automated pattern extraction cannot inject conventions without human oversight. /ac-status gives the user transparency into the entire auto-context pipeline.
Output: skills/ac-review/SKILL.md, skills/ac-status/SKILL.md
</objective>

<execution_context>
@/Users/dgsw67/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dgsw67/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-convention-lifecycle-review/06-RESEARCH.md
@.planning/phases/06-convention-lifecycle-review/06-01-SUMMARY.md
@skills/ac-init/SKILL.md
@skills/ac-reset/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /ac-review skill for mandatory convention approval</name>
  <files>skills/ac-review/SKILL.md</files>
  <action>
Create `skills/ac-review/SKILL.md` following the exact same SKILL.md pattern as ac-init and ac-reset.

**Frontmatter:**
```yaml
---
name: ac-review
description: Review pending convention candidates. Approve, reject, or edit each candidate before it reaches CLAUDE.md.
disable-model-invocation: true
---
```

`disable-model-invocation: true` is CRITICAL (LIFE-06) -- Claude must never auto-invoke this skill. Only the user can trigger convention review.

**Skill body instructions (in markdown, imperative style addressed to Claude):**

**Section 1: Read Pending Candidates**
- Read `.auto-context/candidates.json` in the project root
- Filter for entries where `stage == "review_pending"`
- If no review_pending candidates found, tell the user: "No candidates pending review. Candidates need 3+ observations across 2+ sessions to qualify." and exit
- Count total pending candidates and display: "Found N candidates ready for review."

**Section 2: Present Each Candidate**
- For each review_pending candidate, present in this format:
  ```
  ### Candidate N of M

  **Convention:** {text}
  **Confidence:** {confidence}
  **Observations:** {observations} across {sessions_seen length} sessions
  **First seen:** {created_at}
  **Evidence:**
  {For each evidence item:}
  - `{file}:{line}` â€” {snippet}

  **Action:** approve / reject / edit
  ```
- Wait for user response after each candidate
- Do NOT batch -- present one at a time so each decision is written to disk immediately (prevents context compaction data loss per research Pitfall 5)

**Section 3: Process User Decision**

For **approve**:
1. Read current `.auto-context/conventions.json`
2. Create a new convention entry from the candidate:
   - `text`: candidate's text (unchanged)
   - `confidence`: 0.7 (promoted extraction confidence -- above bootstrap 0.6 midpoint, below explicit 1.0)
   - `source`: "extraction" (preserve original source)
   - `stage`: "active"
   - `created_at`: candidate's created_at (preserve original)
   - `approved_at`: current ISO 8601 timestamp
   - `session_id`: candidate's session_id (preserve original)
   - `last_referenced_session`: read current session_count from `.auto-context/lifecycle.json` (prevents immediate decay per research Pitfall 3)
   - `observations`: candidate's observations count
   - `sessions_seen`: candidate's sessions_seen array
3. Append to conventions.json atomically (jq + tmp + mv)
4. Remove the candidate from candidates.json atomically
5. Log to `.auto-context/changelog.jsonl`: `{"ts":"...","action":"approved","text":"...","reason":"user approved via /ac-review","from_stage":"review_pending","to_stage":"active"}`
6. Confirm: "Approved: {text}"

For **reject**:
1. Remove the candidate from `.auto-context/candidates.json` atomically
2. Log to changelog.jsonl: `{"ts":"...","action":"rejected","text":"...","reason":"user rejected via /ac-review","from_stage":"review_pending","to_stage":"rejected"}`
3. Confirm: "Rejected: {text}"

For **edit**:
1. Ask user for the modified convention text
2. Follow the same approve flow but use the user's edited text instead of the original
3. Log to changelog.jsonl with action "approved_edited" and include both original and modified text in reason
4. Confirm: "Approved (edited): {new_text}"

**Section 4: Post-Review Summary**
- After all candidates are reviewed, show summary: "Review complete: N approved, M rejected, K edited"
- If any were approved, tell the user: "Approved conventions will appear in CLAUDE.md at next session start. Run `/ac-status` to see current pipeline state."

**Important rules (include in SKILL.md):**
- ALWAYS write each decision to disk immediately after the user responds. Never batch decisions.
- Use `jq` for all JSON operations (atomic writes with tmp+mv pattern)
- Use `jq -nc` for JSONL changelog entries
- Read `session_count` from lifecycle.json when setting `last_referenced_session` on approved entries
- If lifecycle.json is missing or corrupt, use `last_referenced_session: 0` as fallback
  </action>
  <verify>
    <automated>test -f skills/ac-review/SKILL.md && grep -q "disable-model-invocation: true" skills/ac-review/SKILL.md && grep -q "review_pending" skills/ac-review/SKILL.md && grep -q "candidates.json" skills/ac-review/SKILL.md && grep -q "conventions.json" skills/ac-review/SKILL.md && grep -q "changelog" skills/ac-review/SKILL.md && grep -q "approve" skills/ac-review/SKILL.md && grep -q "reject" skills/ac-review/SKILL.md && echo "PASS"</automated>
    <manual>Verify SKILL.md has disable-model-invocation: true, presents candidates one at a time, supports approve/reject/edit, writes each decision to disk immediately, sets confidence to 0.7 on approval, reads session_count for last_referenced_session, logs to changelog.jsonl.</manual>
  </verify>
  <done>skills/ac-review/SKILL.md exists with complete review gate instructions: reads review_pending candidates, presents one at a time with evidence, handles approve/reject/edit, writes each decision atomically, logs to changelog, sets appropriate confidence and last_referenced_session.</done>
</task>

<task type="auto">
  <name>Task 2: Create /ac-status skill for pipeline visibility</name>
  <files>skills/ac-status/SKILL.md</files>
  <action>
Create `skills/ac-status/SKILL.md` following the same pattern as other skills.

**Frontmatter:**
```yaml
---
name: ac-status
description: Show auto-context pipeline status including observation counts, candidates, conventions, anti-patterns, and lifecycle statistics.
disable-model-invocation: true
---
```

**Skill body instructions:**

**Section 1: Read Pipeline Data**
- Read the following files from `.auto-context/` in the project root:
  - `conventions.json` -- convention entries with stage field
  - `candidates.json` -- candidate entries with stage and observations
  - `anti-patterns.json` -- anti-pattern entries
  - `lifecycle.json` -- session counter and metadata
  - `config.json` -- token budget configuration
- If `.auto-context/` directory does not exist, tell user: "Auto-context is not initialized. Run `/ac-init` first." and exit.
- Handle missing individual files gracefully (treat as empty arrays / default objects)

**Section 2: Format Status Dashboard**
Present the following dashboard using markdown (Claude's native formatting):

```
## Auto-Context Pipeline Status

### Session Info
- **Session count:** {lifecycle.session_count}
- **Token budget:** {config.token_budget} tokens

### Conventions ({active_count} active)
- Active (in CLAUDE.md): {count where stage=="active"}
- Decayed: {count where stage=="decayed"}
- Convention cap: {active_count}/50

### Candidates ({total_count} total)
- Observations (gathering data): {count where stage=="observation"}
- Ready for review: {count where stage=="review_pending"}
  {If review_pending > 0: "Run `/ac-review` to review pending candidates."}

### Anti-Patterns
- Total: {count from anti-patterns.json}

### Observation Stats
- Total observations across all candidates: {sum of observations field}
- Unique sessions with extractions: {count unique session_ids across candidates}

### Reward Signals
- Reward tracking: pending Phase 7

### Recent Activity
{Read last 5 lines of changelog.jsonl if it exists}
{Format each as: "[timestamp] action: text (reason)"}
{If no changelog: "No lifecycle activity recorded yet."}
```

**Important rules:**
- Use `jq` for all JSON reading and counting
- Use `jq 'length'` for array counts, `jq '[.[] | select(.stage == "active")] | length'` for filtered counts
- Handle missing fields with jq `//` alternative operator
- Read changelog.jsonl with `tail -5` then format each line with jq
- This is a READ-ONLY skill -- never modify any data files
- If any jq command fails (corrupted JSON), show "Error reading {file}" instead of crashing
  </action>
  <verify>
    <automated>test -f skills/ac-status/SKILL.md && grep -q "disable-model-invocation: true" skills/ac-status/SKILL.md && grep -q "conventions.json" skills/ac-status/SKILL.md && grep -q "candidates.json" skills/ac-status/SKILL.md && grep -q "lifecycle.json" skills/ac-status/SKILL.md && grep -q "anti-patterns" skills/ac-status/SKILL.md && grep -q "changelog" skills/ac-status/SKILL.md && echo "PASS"</automated>
    <manual>Verify SKILL.md reads all data files, displays counts by stage, shows convention cap usage, shows review_pending count with /ac-review hint, shows recent changelog activity, is read-only.</manual>
  </verify>
  <done>skills/ac-status/SKILL.md exists with complete pipeline dashboard: convention counts by stage, candidate counts by stage, anti-pattern count, session info, observation stats, recent changelog activity, and reward tracking placeholder for Phase 7.</done>
</task>

</tasks>

<verification>
- skills/ac-review/SKILL.md exists with valid YAML frontmatter (disable-model-invocation: true)
- skills/ac-status/SKILL.md exists with valid YAML frontmatter (disable-model-invocation: true)
- /ac-review references candidates.json, conventions.json, changelog.jsonl, lifecycle.json
- /ac-review supports approve/reject/edit with atomic disk writes per decision
- /ac-review sets confidence to 0.7 and reads session_count for last_referenced_session
- /ac-status reads all pipeline data files and presents formatted dashboard
- /ac-status is read-only (no writes to any data files)
- Both skills follow same SKILL.md pattern as ac-init and ac-reset
</verification>

<success_criteria>
The /ac-review skill provides the mandatory review gate: users invoke it to approve, reject, or edit candidates one at a time with immediate persistence. The /ac-status skill provides full pipeline visibility showing all stages, counts, and recent activity. Both skills have disable-model-invocation: true to ensure user-initiated operation only.
</success_criteria>

<output>
After completion, create `.planning/phases/06-convention-lifecycle-review/06-02-SUMMARY.md`
</output>
