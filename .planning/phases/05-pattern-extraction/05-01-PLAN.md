---
phase: 05-pattern-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - agents/extract-patterns.md
autonomous: true
requirements:
  - EXTR-01
  - EXTR-02
  - EXTR-03
  - EXTR-04

must_haves:
  truths:
    - "Extraction agent prompt instructs the subagent to read session-log.jsonl and identify coding patterns"
    - "Agent prompt defines classification taxonomy: intentional / incidental / framework-imposed / uncertain with examples"
    - "Agent prompt filters: only intentional patterns written to candidates.json"
    - "Agent prompt requires minimum 2 file:line evidence citations per pattern"
    - "Agent prompt includes stop_hook_active guard and minimum event threshold (< 3 events = skip)"
    - "Agent prompt handles deduplication against existing candidates.json entries"
  artifacts:
    - path: "agents/extract-patterns.md"
      provides: "Complete extraction agent instructions"
      contains: "intentional"
  key_links:
    - from: "agents/extract-patterns.md"
      to: ".auto-context/session-log.jsonl"
      via: "Read tool instruction in prompt"
      pattern: "session-log\\.jsonl"
    - from: "agents/extract-patterns.md"
      to: ".auto-context/candidates.json"
      via: "Write tool instruction in prompt"
      pattern: "candidates\\.json"
---

<objective>
Create the pattern extraction agent prompt that drives the Stop hook subagent. This is the intelligence core of Phase 5 -- the prompt instructs the agent to read session logs, identify coding patterns, classify them, gather file:line evidence, and write intentional patterns to candidates.json.

Purpose: The extraction agent prompt is the primary deliverable. It encodes the classification taxonomy (EXTR-02), evidence requirements (EXTR-04), filtering logic (EXTR-03), and analysis instructions (EXTR-01).
Output: agents/extract-patterns.md -- a complete, self-contained agent prompt file.
</objective>

<execution_context>
@/Users/dgsw67/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dgsw67/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-pattern-extraction/05-RESEARCH.md
@scripts/detect-feedback.sh
@scripts/inject-context.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create extraction agent prompt file</name>
  <files>agents/extract-patterns.md</files>
  <action>
Create `agents/extract-patterns.md` with the following structure and content:

**1. Pre-check instructions (top of prompt):**
- Parse `$ARGUMENTS` from hook input (JSON with session_id, cwd, stop_hook_active, etc.)
- If `stop_hook_active` is `true`: return `{"ok": true}` immediately (infinite loop prevention)
- Read `.auto-context/session-log.jsonl` in the project cwd
- Count events excluding `session_start` entries
- If fewer than 3 meaningful events: return `{"ok": true}` immediately (skip trivial sessions)

**2. Pattern analysis instructions:**
- Read each session log entry (file_write, file_edit, bash_command, explicit_feedback events)
- Identify patterns from:
  - File paths: naming conventions (camelCase, kebab-case), directory structure choices
  - File modifications: coding patterns, import styles, error handling approaches
  - Bash commands: build/test/lint conventions, tool preferences
  - Multiple files: consistent patterns across 2+ files carry more weight
- Use Read and Grep tools to inspect actual source files for evidence
- Look for patterns that appear in 2+ files within the session (single-file observations are weak signals)

**3. Classification taxonomy (EXTR-02) -- include definitions AND examples:**

| Classification | Definition | Examples |
|---|---|---|
| intentional | Consistent, deliberate choices the developer makes across files. Not required by any tool or framework. | camelCase function names, specific error handling pattern, import ordering convention, prefer async/await over .then() |
| incidental | One-off patterns or random occurrences without consistency. | A single file using a different naming style, one-time utility function |
| framework-imposed | Patterns required or dictated by the framework, language, or tooling in use. Not a team/developer choice. | Next.js app/ directory structure, React hook naming (useXxx), package.json for npm projects, tsconfig.json for TypeScript |
| uncertain | Not enough evidence to classify. Fewer than 2 occurrences or ambiguous intent. | Pattern seen in only 1 file, could be intentional or incidental |

**4. Filtering rules (EXTR-03):**
- Only write patterns classified as `intentional` to candidates.json
- Do NOT write framework-imposed, incidental, or uncertain patterns
- When in doubt, classify as `uncertain` (conservative approach)

**5. Evidence requirements (EXTR-04):**
- Each pattern MUST have at least 2 evidence citations
- Each citation: `{ "file": "relative/path", "line": N, "snippet": "actual code line" }`
- Use Read tool to get exact line numbers and snippets from source files
- If a pattern cannot get 2+ citations, classify it as `uncertain`

**6. Deduplication instructions:**
- Read existing `.auto-context/candidates.json` before writing
- For each candidate pattern to write:
  - Check if a semantically equivalent pattern already exists
  - If yes: increment its `observations` count, append current session_id to `sessions_seen` array, update evidence with new citations
  - If no: add as new entry
- Semantic equivalence = same convention described in different words (use judgment)

**7. Output format for candidates.json entries:**
```json
{
  "text": "Clear, concise description of the convention",
  "classification": "intentional",
  "confidence": 0.3,
  "source": "extraction",
  "created_at": "ISO-8601 timestamp",
  "session_id": "from hook input",
  "observations": 1,
  "sessions_seen": ["session_id"],
  "evidence": [
    {"file": "relative/path", "line": 5, "snippet": "actual code line"},
    {"file": "another/path", "line": 12, "snippet": "actual code line"}
  ]
}
```

- Confidence starts at 0.3 for single-session extraction (distinguishes from bootstrap 0.6+ and explicit 1.0)
- Source is always "extraction"
- Write the updated candidates.json array atomically (read -> merge -> write)

**8. Final instruction:**
- After writing candidates (or skipping if none found), return: `{"ok": true}`
- NEVER return `{"ok": false}` -- pattern extraction is background work, never block Claude from stopping
- If any error occurs during extraction, log nothing and return `{"ok": true}` gracefully

**Style notes for the prompt:**
- Write as clear, imperative instructions to the agent
- Use markdown headers for each section
- Include the classification table verbatim in the prompt
- Keep total prompt length under 3000 words (agent context budget)
- Reference file paths relative to the project root (the cwd from hook input)
  </action>
  <verify>
    <automated>test -f agents/extract-patterns.md && grep -q "intentional" agents/extract-patterns.md && grep -q "candidates.json" agents/extract-patterns.md && grep -q "stop_hook_active" agents/extract-patterns.md && grep -q "evidence" agents/extract-patterns.md && echo "PASS"</automated>
    <manual>Read the prompt and verify: classification taxonomy present with 4 categories, evidence requirements mention 2+ citations, skip conditions for stop_hook_active and < 3 events, output format matches candidate schema, deduplication instructions present</manual>
  </verify>
  <done>agents/extract-patterns.md exists with complete extraction instructions including: pre-check skip conditions, pattern analysis steps, 4-category classification taxonomy with examples, filtering to intentional-only, 2+ evidence citation requirement, deduplication logic, candidate JSON schema, and graceful error handling</done>
</task>

</tasks>

<verification>
- agents/extract-patterns.md exists and is well-structured markdown
- Prompt references session-log.jsonl for input and candidates.json for output
- Classification taxonomy has 4 categories: intentional, incidental, framework-imposed, uncertain
- Evidence requirement specifies minimum 2 citations with file:line:snippet
- Skip conditions: stop_hook_active=true, fewer than 3 meaningful events
- Deduplication instructions reference reading existing candidates.json
- Always returns {"ok": true}, never {"ok": false}
</verification>

<success_criteria>
The extraction agent prompt is complete, self-contained, and could be used by any Claude subagent to analyze a session log and produce classified, evidence-cited candidate patterns. A different Claude instance reading just this file would know exactly what to do without clarification.
</success_criteria>

<output>
After completion, create `.planning/phases/05-pattern-extraction/05-01-SUMMARY.md`
</output>
