---
phase: 04-explicit-feedback
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/inject-context.sh
autonomous: true
requirements:
  - TRNS-04

must_haves:
  truths:
    - "Session start outputs 'Auto-Context: N conventions active, M candidates pending' via additionalContext"
    - "Anti-pattern count is included in the status line for user awareness"
    - "Status line counts are accurate (match actual JSON array lengths)"
  artifacts:
    - path: "scripts/inject-context.sh"
      provides: "Session-start status line with convention, candidate, and anti-pattern counts"
      contains: "additionalContext"
  key_links:
    - from: "scripts/inject-context.sh"
      to: ".auto-context/conventions.json"
      via: "jq length count"
      pattern: "CONV_COUNT"
    - from: "scripts/inject-context.sh"
      to: ".auto-context/anti-patterns.json"
      via: "jq length count"
      pattern: "anti-patterns\\.json"
---

<objective>
Verify and enhance the session-start status line in inject-context.sh to include anti-pattern counts alongside convention and candidate counts.

Purpose: TRNS-04 requires "Auto-Context: N conventions active, M candidates pending" at session start. The base requirement is already implemented. This plan enhances it to also report anti-pattern counts, giving users full awareness of their explicit feedback capture from Plan 01.
Output: scripts/inject-context.sh (minor enhancement to status line output)
</objective>

<execution_context>
@/Users/dgsw67/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dgsw67/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Primary file this plan modifies:
@scripts/inject-context.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance session-start status line with anti-pattern count</name>
  <files>scripts/inject-context.sh</files>
  <action>
The existing inject-context.sh (lines 53-54, 84-92) already implements the core TRNS-04 requirement:
- Line 53: `CONV_COUNT=$(jq 'length' "$CONVENTIONS_FILE" 2>/dev/null || echo 0)`
- Line 54: `CAND_COUNT=$(jq 'length' "$STORE_DIR/candidates.json" 2>/dev/null || echo 0)`
- Line 89: `"additionalContext": "Auto-Context: ${CONV_COUNT} conventions active, ${CAND_COUNT} candidates pending"`

Enhance by adding an anti-pattern count. Make these specific changes:

1. **Add anti-pattern count** (after line 54, near the existing count lines):
   ```bash
   AP_COUNT=$(jq 'length' "$STORE_DIR/anti-patterns.json" 2>/dev/null || echo 0)
   ```

2. **Update the additionalContext string** (line 89) to include anti-pattern count when non-zero:
   - If AP_COUNT is 0: keep existing format "Auto-Context: N conventions active, M candidates pending"
   - If AP_COUNT > 0: "Auto-Context: N conventions active, M candidates pending, K anti-patterns"

   Implementation: Build the status string in a variable before the cat heredoc:
   ```bash
   STATUS_LINE="Auto-Context: ${CONV_COUNT} conventions active, ${CAND_COUNT} candidates pending"
   [ "$AP_COUNT" -gt 0 ] && STATUS_LINE="${STATUS_LINE}, ${AP_COUNT} anti-patterns"
   ```

   Then use `${STATUS_LINE}` in the additionalContext output.

3. **No other changes**: Do not modify the injection pipeline, marker logic, data store init, or any other part of inject-context.sh. This is a surgical enhancement to the status output only.

IMPORTANT: The anti-patterns.json file is already initialized by inject-context.sh line 22 (`[ -f "$STORE_DIR/anti-patterns.json" ] || echo '[]' > "$STORE_DIR/anti-patterns.json"`), so it will always exist when we count it.
  </action>
  <verify>
    <automated>bash -n /Users/dgsw67/auto-context/scripts/inject-context.sh && grep -q "anti-pattern" /Users/dgsw67/auto-context/scripts/inject-context.sh && grep -q "additionalContext" /Users/dgsw67/auto-context/scripts/inject-context.sh && echo "PASS: syntax valid, anti-pattern count and additionalContext present"</automated>
    <manual>
Verify the status line logic by reading the modified inject-context.sh and confirming:
1. AP_COUNT is computed from anti-patterns.json
2. STATUS_LINE includes anti-pattern count conditionally (only when > 0)
3. The additionalContext uses STATUS_LINE variable
4. No other logic in inject-context.sh was changed
    </manual>
  </verify>
  <done>inject-context.sh outputs status line with convention count, candidate count, and (when non-zero) anti-pattern count. The status line matches TRNS-04 spec: "Auto-Context: N conventions active, M candidates pending". Anti-pattern count is an additive enhancement that appears only when relevant. No regression to existing injection pipeline.</done>
</task>

</tasks>

<verification>
1. `bash -n scripts/inject-context.sh` -- syntax still valid after changes
2. `grep "AP_COUNT" scripts/inject-context.sh` -- anti-pattern count variable exists
3. `grep "STATUS_LINE" scripts/inject-context.sh` -- status line built as variable
4. `grep "additionalContext" scripts/inject-context.sh` -- output still present
5. Existing CLAUDE.md injection pipeline unchanged (diff shows only status line area modified)
</verification>

<success_criteria>
- TRNS-04 status line "Auto-Context: N conventions active, M candidates pending" works at session start
- Anti-pattern count shown when > 0 (additive, does not break base format)
- No regression to convention injection, marker management, or data store initialization
- bash -n syntax check passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-explicit-feedback/04-02-SUMMARY.md`
</output>
